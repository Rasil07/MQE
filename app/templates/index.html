<!-- app/templates/index.html -->
{% extends 'base.html' %} {% block content %}
<div class="container" style="display: flex; gap: 32px; flex-wrap: wrap">
  <!-- Main Section: Upload Form + Upload Log List -->
  <div style="flex: 2 1 400px; min-width: 350px">
    <h2 class="section-title">Upload Excel File</h2>
    <form
      enctype="multipart/form-data"
      id="uploadForm"
      class="upload-form"
      style="margin-bottom: 24px"
      onsubmit="upload(event)"
    >
      <input
        type="file"
        id="fileInput"
        accept=".xlsx, .xls"
        name="file"
        class="file-input"
        required
      />
      <button type="submit" class="upload-btn" id="uploadBtn">
        Upload File
      </button>
    </form>

    <div class="files-section">
      <h3 class="section-title">Uploaded Files</h3>
      <hr />
      {% if files %}
      <div
        style="
          max-height: 420px;
          overflow-y: auto;
          padding: 0.5em 0.5em 0.5em 0.5em;
        "
      >
        <ul
          class="file-list"
          style="margin: 0; padding: 10px; list-style: none"
        >
          {% for file in files %}
          <li
            class="file-item"
            style="border-bottom: 1px solid #e0e0e0; padding: 10px 8px"
          >
            <div>
              <div class="file-name" style="font-weight: bold">
                {{ file.name }}
              </div>
              <div style="font-size: 0.95em; color: #666">
                ID: {{ file.identifier }} | Uploaded: {{ file.created_at if
                file.created_at else 'N/A' }}
              </div>
            </div>
            <div style="font-size: 0.95em; color: #444; padding: 12px">
              {% if file.transaction_row_count %}
              <div>Transactions: {{ file.transaction_row_count }}</div>
              {% endif %} {% if file.customer_row_count %}
              <div>Customers: {{ file.customer_row_count }}</div>
              {% endif %} {% if file.product_row_count %}
              <div>Products: {{ file.product_row_count }}</div>
              {% endif %}
            </div>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% else %}
      <div class="no-files">No files uploaded yet.</div>
      {% endif %}
    </div>
  </div>

  <!-- Upload Details Section - Hidden initially and after download -->
  <div class="file-info" id="uploadDetailsSection" style="display: none">
    <h2 class="section-title" style="margin-top: 0">Latest Upload Details</h2>
    {% if files and files|length > 0 %} {% set latest = files[0] %}
    <div style="margin-bottom: 12px">
      <div style="font-weight: bold; font-size: 1.1em">{{ latest.name }}</div>
      <div style="color: #666; font-size: 0.97em">
        ID: {{ latest.identifier }}<br />
        Uploaded: {{ latest.created_at if latest.created_at else 'N/A' }}
      </div>
    </div>
    <div style="margin-bottom: 12px">
      {% if latest.transaction_row_count %}
      <div>Transactions: {{ latest.transaction_row_count }}</div>
      {% endif %} {% if latest.customer_row_count %}
      <div>Customers: {{ latest.customer_row_count }}</div>
      {% endif %} {% if latest.product_row_count %}
      <div>Products: {{ latest.product_row_count }}</div>
      {% endif %}

      <button
        type="button"
        class="download-btn"
        id="downloadBtn"
        onclick="downloadReport()"
        style="
          padding: 8px 18px;
          background: #1976d2;
          color: #fff;
          border: none;
          border-radius: 4px;
          cursor: pointer;
        "
      >
        Download Processed Excel File
      </button>
    </div>

    {% else %}
    <div style="color: #888">No uploads yet.</div>
    {% endif %}
  </div>
</div>

<script>
  // Helper to create a message element under the form
  function showMessage(message, isSuccess) {
    let msgDiv = document.getElementById("uploadMessage");
    if (!msgDiv) {
      msgDiv = document.createElement("div");
      msgDiv.id = "uploadMessage";
      msgDiv.style.marginTop = "10px";
      document.getElementById("uploadForm").after(msgDiv);
    }
    msgDiv.textContent = message;
    msgDiv.style.color = isSuccess ? "green" : "red";
  }

  function clearMessage() {
    let msgDiv = document.getElementById("uploadMessage");
    if (msgDiv) {
      msgDiv.remove();
    }
  }

  // Helper to fetch and update the file list and latest file detail
  function updateFileList() {
    fetch("/")
      .then((response) => response.text())
      .then((html) => {
        // Parse the returned HTML and extract the file list and latest file detail
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");
        const newFilesSection = doc.querySelector(".files-section");
        const currentFilesSection = document.querySelector(".files-section");
        if (newFilesSection && currentFilesSection) {
          currentFilesSection.innerHTML = newFilesSection.innerHTML;
        }
        // Update the latest file detail section
        const newLatestSection = doc.querySelector(
          ".container > div:nth-child(2)"
        );
        const currentLatestSection = document.querySelector(
          ".container > div:nth-child(2)"
        );
        if (newLatestSection && currentLatestSection) {
          currentLatestSection.innerHTML = newLatestSection.innerHTML;
        }
      });
  }

  // Show upload details section
  function showUploadDetails() {
    const uploadDetailsSection = document.getElementById(
      "uploadDetailsSection"
    );
    if (uploadDetailsSection) {
      uploadDetailsSection.style.display = "block";
    }
  }

  // Hide upload details section
  function hideUploadDetails() {
    const uploadDetailsSection = document.getElementById(
      "uploadDetailsSection"
    );
    if (uploadDetailsSection) {
      uploadDetailsSection.style.display = "none";
    }
  }

  // Hide the download button initially
  const downloadBtn = document.getElementById("downloadBtn");
  if (downloadBtn) {
    downloadBtn.style.display = "none";
  }

  // Show the download button only after successful upload and report generation
  function showDownloadButton() {
    const downloadBtn = document.getElementById("downloadBtn");
    if (downloadBtn) {
      downloadBtn.style.display = "inline-block";
    }
  }

  // Hide the download button (e.g., after upload starts)
  function hideDownloadButton() {
    const downloadBtn = document.getElementById("downloadBtn");
    if (downloadBtn) {
      downloadBtn.style.display = "none";
    }
  }

  // Hide download button on page load and when upload starts
  hideDownloadButton();

  hideUploadDetails();

  function upload(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const downloadBtn = document.getElementById("downloadBtn");

    console.log({ formData });

    if (!fileInput.files[0]) {
      showMessage("Please select a file to upload.", false);
      return;
    }

    if (uploadBtn) {
      uploadBtn.disabled = true;
      uploadBtn.textContent = "Uploading...";
    }

    if (downloadBtn) {
      downloadBtn.disabled = true;
      downloadBtn.textContent = "Generating report...";
    }

    //       // First API call: Upload file and save to database
    fetch("/file/upload", {
      method: "POST",
      body: formData,
    })
      .then((response) =>
        response
          .json()
          .then((data) => ({ status: response.status, body: data }))
      )
      .then(({ status, body }) => {
        console.log({ status, body });
        if (body.message) {
          if (status === 200 && body.message === "File uploaded successfully") {
            showMessage(
              "File uploaded successfully. Generating report...",
              true
            );
            showDownloadButton(); // Show download button after upload success
            showUploadDetails(); // Show upload details after successful upload

            // Second API call: Generate report
            const reportFormData = new FormData();
            reportFormData.append("file", fileInput.files[0]);

            return fetch("/file/generate-report", {
              method: "POST",
              body: reportFormData,
            });
          } else {
            showMessage(body.message, false);
            throw new Error(body.message);
          }
        }
      })
      .then((response) => {
        if (response) {
          return response
            .json()
            .then((data) => ({ status: response.status, body: data }));
        }
      })
      .then(({ status, body }) => {
        if (body && body.message) {
          if (
            status === 200 &&
            body.message === "Report generated successfully"
          ) {
            showMessage(
              "File uploaded and report generated successfully!",
              true
            );
            fileInput.value = "";
            updateFileList();
            setTimeout(clearMessage, 3000);
          } else {
            showMessage(body.message, false);
          }
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        showMessage(
          "An error occurred during upload or report generation.",
          false
        );
      })
      .finally(() => {
        const uploadBtn = document.getElementById("uploadBtn");
        const downloadBtn = document.getElementById("downloadBtn");

        if (uploadBtn) {
          uploadBtn.disabled = false;
          uploadBtn.textContent = "Upload File";
        }

        if (downloadBtn) {
          downloadBtn.disabled = false;
          downloadBtn.textContent = "Download Processed Excel File";
        }
      });
  }

  function downloadReport() {
    fetch("/file/download-report")
      .then((response) => {
        if (!response.ok) {
          throw new Error("Network response was not ok");
        }
        return response.blob();
      })
      .then((blob) => {
        console.log({ blob });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "Report.xlsx";
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
        const downloadBtn = document.getElementById("downloadBtn");
        const uploadDetailsSection = document.getElementById(
          "uploadDetailsSection"
        );

        if (downloadBtn) {
          downloadBtn.style.display = "none";
        }
        if (uploadDetailsSection) {
          uploadDetailsSection.style.display = "none";
        }
      })
      .catch((error) => {
        alert("An error occurred during download.");
        console.error("Download error:", error);
      });
  }
</script>
{% endblock %}
